---
import { Image } from "astro:assets";
import BaseLayout from "@/layouts/BaseLayout.astro";
import "@fancyapps/ui/dist/fancybox/fancybox.css";

// 使用 fs 的 promise 版本以提高构建时的并发处理能力
import fs from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";
import ExifParser from "exif-parser";

// 1. 定义 SVG 图标 (保持不变)
const ICONS = {
  camera: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2-2z"/><circle cx="12" cy="13" r="4"/></svg>`,
  lens: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="14.31" y1="8" x2="20.05" y2="17.94"/><line x1="9.69" y1="8" x2="21.17" y2="8"/><line x1="7.38" y1="12" x2="13.12" y2="2.06"/><line x1="9.69" y1="16" x2="3.95" y2="6.06"/><line x1="14.31" y1="16" x2="2.83" y2="16"/><line x1="16.62" y1="12" x2="10.88" y2="21.94"/></svg>`,
  aperture: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M22 12h-4"/><path d="M6 12H2"/><path d="M12 6V2"/><path d="M12 18v4"/></svg>`,
  shutter: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M22 12h-4"/><path d="M6 12H2"/><path d="M12 6V2"/><path d="M12 18v4"/></svg>`,
  iso: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M7 12h.01"/><path d="M12 12h.01"/><path d="M17 12h.01"/></svg>`,
};

// 2. 获取图片
// 注意：这里的 Import 仅用于 Astro 处理和获取构建后的引用路径
const images = import.meta.glob<{ default: ImageMetadata }>(
  "../images/*.{jpg,jpeg,png,webp,tiff}",
);

function formatShutterSpeed(time: number | undefined) {
  if (!time) return "";
  if (time >= 1) return `${time}s`;
  const fraction = Math.round(1 / time);
  return `1/${fraction}s`;
} // 获取当前文件的目录路径，用于解析相对路径
// 3. 数据预处理
const imageEntries = await Promise.all(
  Object.entries(images).map(async ([relativePath, imageLoader]) => {
    try {
      const { default: imageData } = await imageLoader();
      const filename = relativePath.split("/").pop()?.split(".")[0] || "";
      const altText = filename
        .replace(/[-_]/g, " ")
        .replace(/^\w/, (c) => c.toUpperCase());

      let captionHtml = "";

      try {
        // 获取文件名
        const imageFileName = path.basename(relativePath);
        // 拼接源文件绝对路径
        const imagePath = path.join(
          process.cwd(),
          "src",
          "images",
          imageFileName,
        );
        // 读取文件
        const buffer = await fs.readFile(imagePath);

        const parser = ExifParser.create(buffer);
        const result = parser.parse();

        if (result.tags) {
          const {
            Model,
            LensModel,
            FNumber,
            ExposureTime,
            ISO,
            FocalLength,
            FocalLengthIn35mmFormat,
          } = result.tags;

          const items: string[] = [];

          if (Model)
            items.push(
              `<span class="exif-tag" title="Camera">${ICONS.camera} ${Model}</span>`,
            );
          if (LensModel)
            items.push(
              `<span class="exif-tag" title="Lens">${ICONS.lens} ${LensModel}</span>`,
            );

          const displayFocal = FocalLengthIn35mmFormat || FocalLength;
          if (displayFocal)
            items.push(
              `<span class="exif-tag" title="Focal Length">${ICONS.lens} ${displayFocal}mm</span>`,
            );

          if (FNumber)
            items.push(
              `<span class="exif-tag" title="Aperture">${ICONS.aperture} f/${FNumber}</span>`,
            );
          if (ExposureTime)
            items.push(
              `<span class="exif-tag" title="Shutter">${ICONS.shutter} ${formatShutterSpeed(ExposureTime)}</span>`,
            );
          if (ISO)
            items.push(
              `<span class="exif-tag" title="ISO">${ICONS.iso} ${ISO}</span>`,
            );

          if (items.length > 0) {
            captionHtml = `<div class="exif-info">${items.join("")}</div>`;
          }
        }
      } catch (exifErr) {
        // --- 修复点：添加类型断言 ---
        const errorMsg =
          exifErr instanceof Error ? exifErr.message : String(exifErr);
        console.warn(
          `[EXIF Skip] Could not read EXIF for ${filename}:`,
          errorMsg,
        );
      }

      const captionText =
        captionHtml || `<div class="exif-filename">${filename}</div>`;

      return {
        imageData,
        originalSrc: imageData.src,
        altText,
        captionText,
        filename,
      };
    } catch (e) {
      console.error(`Error processing ${relativePath}`, e);
      return null;
    }
  }),
).then((results) =>
  results.filter((item): item is NonNullable<typeof item> => item !== null),
);
---

<BaseLayout title="Photo Gallery" description="Masonry style gallery">
  <section class="masonry-container">
    <div class="masonry-grid" id="gallery-grid">
      {
        imageEntries.map(({ imageData, originalSrc, altText, captionText }, index) => (
          <div class="masonry-item">
            <!-- 
              核心修改：
              href={originalSrc}: 确保 Fancybox 打开的是原始大图（通常是 JPG）
              data-caption={captionText}: 包含服务端预渲染的 EXIF HTML
            -->
            <a
              href={originalSrc}
              class="gallery-link"
              data-fancybox="gallery"
              data-caption={captionText}
              aria-label={`View ${altText}`}
              data-width={imageData.width}
              data-height={imageData.height}
            >
              <!-- 
                Image 组件:
                src={imageData}: Astro 会自动处理压缩、生成 WebP
                注意：这里不需要 force format="jpg"，让它生成 WebP 更快
              -->
              <Image
                src={imageData}
                alt={altText}
                width={600} 
                decoding="async"
                quality={80}
                loading={index < 6 ? "eager" : "lazy"} 
                fetchpriority={index < 2 ? "high" : "auto"}
                class="gallery-img"
              />
              <div class="overlay">
                <span class="title">{altText}</span>
              </div>
            </a>
          </div>
        ))
      }
    </div>
  </section>
</BaseLayout>

<style is:global>
  /* 保持你的 Fancybox 样式不变 */
  :root {
    --f-bg: #ffffff;
    --f-button-color: #333;
    --f-button-hover-color: #000;
  }
  .fancybox__backdrop {
    background: rgba(255, 255, 255, 0.98) !important;
    will-change: opacity;
  }
  .fancybox__slide {
    padding: 0 !important;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .fancybox__content {
    transform: translate3d(0, 0, 0); 
    will-change: transform, opacity; 
    backface-visibility: hidden;
  }
  .fancybox__content img, img.f-panzoom__content {
    border-radius: 8px !important; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important;
  }
  @media (min-width: 1024px) {
    .fancybox__content { margin: 60px; }
  }

  /* --- EXIF 信息栏美化 (替换原有的样式) --- */
  
  /* 容器：使用 Flexbox 自动换行并居中 */
  .fancybox__caption .exif-info {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;       /* 允许换行，防止手机上溢出 */
    gap: 8px 12px;        /* 关键：行间距8px，列间距12px，把数据隔开 */
    padding-top: 12px;
    margin-top: 12px;
    border-top: 1px solid rgba(0,0,0,0.06); /* 顶部加一条淡淡的分隔线 */
  }

  /* 每一个数据项 (胶囊样式) */
  .exif-tag {
    display: inline-flex;
    align-items: center;
    height: 28px;          /* 固定高度 */
    padding: 0 10px;       /* 左右内边距 */
    border-radius: 14px;   /* 圆角，形成胶囊形状 */
    background-color: #f3f4f6; /* 浅灰色背景 */
    color: #374151;        /* 深灰色文字 */
    
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace; /* 等宽字体让数字更好看 */
    font-size: 0.8rem;     /* 稍微调小字号 */
    font-weight: 500;
    
    transition: all 0.2s ease;
    border: 1px solid transparent; /* 预留边框位置 */
  }

  /* 悬停效果 */
  .exif-tag:hover {
    background-color: #e5e7eb;
    color: #111827;
    transform: translateY(-1px); /* 微微上浮 */
  }

  /* 图标样式 */
  .exif-tag svg {
    width: 14px;
    height: 14px;
    margin-right: 6px;     /* 图标和文字的间距 */
    color: #6b7280;        /* 图标颜色稍淡 */
    flex-shrink: 0;        /* 防止图标被压缩 */
  }

  /* 如果不需要显示文件名，可以美化它，或者干脆隐藏 */
  .exif-filename {
    font-size: 0.9rem;
    color: #9ca3af;
    margin-top: 4px;
  }

  /* 修改 Fancybox 标题默认样式，避免太靠近图片 */
  .fancybox__caption {
    color: #333;
    padding: 20px 0;
  }

  /* --- 移动端适配 --- */
  @media (max-width: 640px) {
    .fancybox__caption .exif-info {
      gap: 6px 8px; /* 手机上间距稍微小一点 */
    }
    .exif-tag {
      font-size: 0.75rem; /* 手机上字号更小 */
      height: 24px;
      padding: 0 8px;
    }
  }
</style>

<script>
  import { Fancybox } from "@fancyapps/ui";

  // 绑定 Fancybox
  (Fancybox as any).bind('[data-fancybox="gallery"]', {
    preload: 3, 
    Thumbs: { autoStart: false },
    Toolbar: {
      display: { right: ["close"] },
    },
    Images: { 
      fit: "contain",
      zoom: true,
      Panzoom: { maxScale: 2 }
    },
    // 使用 HTML 作为 caption，这样 data-caption 里的 HTML 标签才会被渲染
    Caption: {
      type: "html",
    },
    dragToClose: true,
    animated: true,
    showClass: "f-zoomInUp",
    hideClass: "f-fadeOut",
  });

  // 瀑布流动画逻辑 (保持你的代码)
  document.addEventListener('DOMContentLoaded', () => {
    const items = document.querySelectorAll('.masonry-item');
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry, i) => {
        if (entry.isIntersecting) {
          const target = entry.target as HTMLElement;
          target.style.transitionDelay = `${i * 80}ms`;
          requestAnimationFrame(() => {
            target.classList.add('visible');
          });
          observer.unobserve(target);
        }
      });
    }, { 
      threshold: 0.1, 
      rootMargin: "50px" 
    });
    items.forEach((item) => observer.observe(item));
  });
</script>

<style>
  /* 布局样式 (保持你的代码) */
  .masonry-container {
    width: 100%;
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
  }
  .masonry-grid {
    column-count: 1;
    column-gap: 20px;
  }
  @media (min-width: 640px) { .masonry-grid { column-count: 2; } }
  @media (min-width: 1024px) { .masonry-grid { column-count: 3; } }
  @media (min-width: 1440px) { .masonry-grid { column-count: 4; } }

  .masonry-item {
    break-inside: avoid; 
    margin-bottom: 20px;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease-out, transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    border-radius: 12px;
    background: rgba(128, 128, 128, 0.05);
    overflow: hidden;
    position: relative;
    isolation: isolate; 
  }

  .masonry-item.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .gallery-link {
    display: block;
    position: relative;
    cursor: zoom-in;
    width: 100%;
    -webkit-tap-highlight-color: transparent; 
  }

  .gallery-img {
    display: block;
    width: 100%;
    height: auto;
    will-change: transform;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    backface-visibility: hidden; 
    transform: translate3d(0, 0, 0); 
  }

  @media (hover: hover) {
    .gallery-link:hover .gallery-img { 
      transform: scale(1.025) translate3d(0, 0, 0); 
    }
  }

  .overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 40%);
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    align-items: flex-end;
    padding: 16px;
    pointer-events: none;
  }

  .gallery-link:hover .overlay { opacity: 1; }

  .title {
    color: white;
    font-size: 0.9rem;
    font-weight: 500;
    transform: translateY(8px);
    transition: transform 0.3s ease;
  }

  .gallery-link:hover .title { transform: translateY(0); }
</style>