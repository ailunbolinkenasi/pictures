---
import { Image } from "astro:assets";
import BaseLayout from "~/layouts/BaseLayout.astro";
import "@fancyapps/ui/dist/fancybox/fancybox.css";
import "atropos/css";

const images = import.meta.glob<{ default: ImageMetadata }>(
  "../images/*.{jpg,jpeg,png,webp}",
);
---

<BaseLayout
  title="我旅途中的一生."
  description="A minimal, single-page photo gallery for Astro."
>
  <section class="masonry-gallery" id="photoswipe">
    {
      Object.entries(images).map(async ([_path, image], index) => {
        const { default: imageData } = await image();
        return (
          <div
            class="masonry-item atropos photo-3d"
            data-atropos
            data-atropos-perspective="1000"
            data-atropos-rotate-x-max="15"
            data-atropos-rotate-y-max="15"
            data-atropos-duration="300"
            data-atropos-shadow-scale="1.05"
          >
            <!-- LDRS Ring 加载动画 -->
            <div class="loading-ring">
              <l-ring size="32" stroke="3" bg-opacity="0.1" speed="2" color="#666"></l-ring>
            </div>
            
            <div class="atropos-scale">
              <div class="atropos-rotate">
                <div class="atropos-inner">
                  <a
                    href={imageData.src}
                    target="_blank"
                    data-fancybox="gallery"
                    data-atropos-offset="5"
                    style={`aspect-ratio: ${imageData.width} / ${imageData.height};`}
                  >
                    <Image
                      format="webp"
                      src={imageData}
                      alt=""
                      widths={[320, 480, 640, 800, 1024, 1280]}
                      sizes="(max-width: 600px) 100vw, (max-width: 1024px) 50vw, 33vw"
                      loading={index < 8 ? "eager" : "lazy"}
                      decoding="async"
                      fetchpriority={index < 4 ? "high" : "auto"}
                      data-atropos-offset="0"
                      class="photo-image"
                    />
                  </a>
                </div>
              </div>
            </div>
          </div>
        );
      })
    }
  </section>
</BaseLayout>

<script>
  import { Fancybox } from "@fancyapps/ui";
  import Atropos from "atropos";
  import { ring } from "ldrs";

  // 注册 LDRS Ring 动画
  ring.register();

  // 初始化 Fancybox
  const fbOptions: any = {
    theme: "auto",
    mainStyle: {
      "--f-button-width": "44px",
      "--f-button-height": "44px",
      "--f-button-border-radius": "50%",
      "--f-toolbar-padding": "16px",
      "--f-content-border-radius": "8px",
    },
    Images: { zoom: false },
    Carousel: {
      Arrows: false,
      Toolbar: {
        display: {
          left: [],
          middle: [],
          right: ["close"],
        },
      },
      transition: "fade",
      preload: 2,
    },
  };
  Fancybox.bind("[data-fancybox]", fbOptions);

  // 初始化 Atropos 3D 效果和图片加载处理
  document.addEventListener("DOMContentLoaded", () => {
    const atroposElements = document.querySelectorAll(".atropos");
    const isCoarse = matchMedia("(pointer: coarse)").matches || window.innerWidth < 768;
    
    atroposElements.forEach((element) => {
      const htmlElement = element as HTMLElement;
      const loadingRing = htmlElement.querySelector('.loading-ring') as HTMLElement;
      const photoImage = htmlElement.querySelector('.photo-image') as HTMLImageElement;
      
      // 初始化 Atropos（非移动端）
      if (!isCoarse) {
        new (Atropos as any)({
          el: htmlElement,
          activeOffset: 40,
          shadowScale: 1.05,
          onEnter() {
            htmlElement.style.zIndex = "10";
          },
          onLeave() {
            htmlElement.style.zIndex = "1";
          },
        });
      }
      
      // 处理图片加载
      if (photoImage && loadingRing) {
        photoImage.addEventListener('load', () => {
          loadingRing.style.opacity = '0';
          photoImage.style.opacity = '1';
          
          setTimeout(() => {
            loadingRing.style.display = 'none';
          }, 300);
        });
        
        // 如果图片已经加载完成
        if (photoImage.complete) {
          loadingRing.style.opacity = '0';
          photoImage.style.opacity = '1';
          loadingRing.style.display = 'none';
        }
      }
    });
  });
</script>

<style>
  /* 页面进入动画 */
  @keyframes pageEnter {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* 图片加载动画 */
  @keyframes imageLoad {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* 图片骨架屏动画 */
  @keyframes shimmer {
    0% {
      background-position: -200px 0;
    }
    100% {
      background-position: calc(200px + 100%) 0;
    }
  }


















  /* Fancybox 弹出框圆角样式 */
  :global(.fancybox__content) {
    border-radius: 8px !important;
    overflow: hidden;
  }

  :global(.fancybox__slide img) {
    border-radius: 8px;
    transition: transform 0.3s ease, border-radius 0.3s ease;
  }

  /* 确保在不同缩放状态下保持圆角 */
  :global(.fancybox__slide.is-selected img) {
    border-radius: 8px;
  }

  /* 兼容性增强 */
  :global(.fancybox__content > *) {
    border-radius: 8px;
  }
  /* Masonry 布局（纯 CSS，多列，性能优） */
  .masonry-gallery {
    --gap: 12px;
    padding: var(--gap);
    column-gap: var(--gap);
    column-width: 280px;
    animation: pageEnter 0.8s ease-out;
  }

  @media (min-width: 768px) {
    .masonry-gallery {
      --gap: 16px;
      column-width: 340px;
      padding: var(--gap);
    }
  }

  @media (min-width: 1024px) {
    .masonry-gallery {
      --gap: 20px;
      column-width: 380px;
    }
  }

  @media (min-width: 1440px) {
    .masonry-gallery {
      --gap: 24px;
      column-width: 440px;
    }
  }

  @media (min-width: 1920px) {
    .masonry-gallery {
      --gap: 28px;
      column-width: 500px;
    }
  }

  /* 每个卡片避免在列中被拆分，兼容前缀 */
  .masonry-item {
    display: inline-block;
    width: 100%;
    margin: 0 0 var(--gap);
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    -moz-column-break-inside: avoid;
    page-break-inside: avoid;
    position: relative;
    z-index: 1;
    transition: z-index 0.3s ease;
    content-visibility: auto;
    contain: layout style paint;
  }

  .masonry-item a {
    display: block;
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.3s ease-in-out;
    will-change: transform;
  }

  .masonry-item a img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    transition: transform 0.3s ease, opacity 0.2s ease;
    will-change: transform, opacity;
    transform: translateZ(0);
  }

  /* LDRS Ring 加载动画样式（masonry 命名空间） */
  .masonry-gallery .loading-ring {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  /* 图片初始与加载后状态 */
  .masonry-gallery .photo-image {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .masonry-gallery .photo-3d:hover a img {
    transform: scale(1.02);
  }

  /* Atropos 圆角统一 */
  .masonry-gallery .atropos,
  .masonry-gallery .atropos-inner {
    border-radius: 8px;
  }

  /* 可访问性与聚焦态 */
  .masonry-gallery a:focus-visible {
    outline: 3px solid var(--outline);
    outline-offset: 2px;
    transform: scale(1.03);
    z-index: 2;
    border-radius: 2px;
    box-shadow: 0 2px 4px 2px rgba(0, 0, 0, 0.1);
  }

  /* 移动端降低 3D 强度与 Ring 尺寸 */
  @media (max-width: 768px) {
    .masonry-gallery .photo-3d[data-atropos] {
      --atropos-rotate-x-max: 8;
      --atropos-rotate-y-max: 8;
    }
    .masonry-gallery .loading-ring l-ring {
      --size: 24px;
    }
  }

  /* 暗色主题下的 Ring 颜色 */
  @media (prefers-color-scheme: dark) {
    .masonry-gallery .loading-ring l-ring {
      --color: #ccc;
    }
  }
</style>
